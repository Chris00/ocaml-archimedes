OCAMLFIND  = @OCAMLFIND@
PP	   =
OCAMLC     = @OCAMLC@
OCAMLOPT   = @OCAMLOPT@
OCAMLDEP   = @OCAMLDEP@
OCAMLDOC   = @OCAMLDOC@
OCAMLMKLIB = @OCAMLMKLIB@
OCAMLLIB   = @OCAMLLIB@

OCAMLC_FLAGS ?= -annot -g
OCAMLOPT_FLAGS ?= -annot -inline 3 -w DEFPSVYZX
PP_FLAGS = $(if $(PP), -pp "$(PP)")

OCAML_PACKAGES = $(if $(OCAMLPACKS), -package $(OCAMLPACKS))
LINKPKG = $(if $(OCAMLPACKS), -linkpkg)
OCAMLC_FLAGS += $(if $(OCAMLINCLUDES), $(addprefix -I , $(OCAMLINCLUDES)))
OCAMLOPT_FLAGS += $(if $(OCAMLINCLUDES), $(addprefix -I , $(OCAMLINCLUDES)))

OCAMLFIND_OCAMLC = $(if $(OCAMLFIND), $(OCAMLFIND) ocamlc, $(OCAMLC))
OCAMLFIND_OCAMLOPT = $(if $(OCAMLFIND), $(OCAMLFIND) ocamlopt, $(OCAMLOPT))
OCAMLFIND_OCAMLDEP = $(if $(OCAMLFIND), $(OCAMLFIND) ocamldep, $(OCAMLDEP))

%.cmi: %.mli
	$(OCAMLFIND_OCAMLC) $(PP_FLAGS) $(OCAMLC_FLAGS) $(OCAML_PACKAGES) -c $<

%.cmi: %.ml
	$(OCAMLFIND_OCAMLC) $(PP_FLAGS) $(OCAMLC_FLAGS) $(OCAML_PACKAGES) -c $<

%.cmo: %.ml
	$(OCAMLFIND_OCAMLC) $(PP_FLAGS) $(OCAMLC_FLAGS) $(OCAML_PACKAGES) -c $<

%.cma:
	$(OCAMLFIND_OCAMLC) $(PP_FLAGS) -a -o $@ $(OCAMLC_FLAGS) $^

%.cmx: %.ml
	$(OCAMLFIND_OCAMLOPT) $(PP_FLAGS) $(OCAMLOPT_FLAGS) $(OCAML_PACKAGES) -c $<

%.cmxa:
	$(OCAMLFIND_OCAMLOPT) $(PP_FLAGS) -a -o $@ $(OCAMLOPT_FLAGS) $^

%.exe: %.cmo
	$(OCAMLFIND_OCAMLC) -o $@ $(PP_FLAGS) $(OCAMLC_FLAGS) \
	  $(LIBS_CMA) $(filter %.cmo %.cma,$(filter-out $<,$+)) \
	  $(OCAML_PACKAGES) $(LINKPKG) $<

%.com: %.cmx
	$(OCAMLFIND_OCAMLOPT) -o $@ $(PP_FLAGS) $(OCAMLOPT_FLAGS) \
	  $(LIBS_CMXA) $(filter %.cmx %.cmxa,$(filter-out $<,$+)) \
	  $(OCAML_PACKAGES) $(LINKPKG) $<

.depend.ocaml: $(wildcard *.ml) $(wildcard *.mli)
	@echo "Building $@ ... "
	-@test -z "$^" || $(OCAMLFIND_OCAMLDEP) $(PP_FLAGS) $(SYNTAX_OPTS) $^ > $@
# If we do not force inclusion (e.g. with "-" prefix), then it is not
# recreated and taken into account properly.
include .depend.ocaml


.PHONY: clean
clean::
	$(RM) $(wildcard *~ *.annot *.cmi *.cmo *.cma *.cmx *.cmxa *.cmxs)
	$(RM) $(wildcard *.o *.a)
